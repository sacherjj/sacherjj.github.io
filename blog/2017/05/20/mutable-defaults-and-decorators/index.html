<!DOCTYPE html>
<html lang="en-us">

  <head>
  <meta charset="utf-8">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Python: Mutable Defaults and Decorators</title>
  <meta name="author" content="" />

  

  
  <meta name="description" content="My little piece of the web.">	
  

  <meta name="generator" content="Hugo 0.30.2" />

  <link href='//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800' rel='stylesheet' type='text/css'>

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  
  <link href="http://www.joesacher.com/css/animate.css" rel="stylesheet">

  
  
    <link href="http://www.joesacher.com/css/style.default.css" rel="stylesheet" id="theme-stylesheet">
  


  
  <link href="http://www.joesacher.com/css/custom.css" rel="stylesheet">

  
  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
  <link rel="shortcut icon" href="http://www.joesacher.com/img/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="http://www.joesacher.com/img/apple-touch-icon.png" />

  




  <link rel="alternate" href="http://www.joesacher.com/index.xml" type="application/rss+xml" title="joesacher.com">

  
  <meta property="og:title" content="Python: Mutable Defaults and Decorators" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/blog/2017/05/20/mutable-defaults-and-decorators//" />
  <meta property="og:image" content="img/logo.png" />

</head>


  <body>

    <div id="all">

        <header>

          <div class="navbar-affixed-top" data-spy="affix" data-offset-top="200">

    <div class="navbar navbar-default yamm" role="navigation" id="navbar">

        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand home" href="http://www.joesacher.com/">
                    <img src="http://www.joesacher.com/img/logo.png" alt="Python: Mutable Defaults and Decorators logo" class="hidden-xs hidden-sm">
                    <img src="http://www.joesacher.com/img/logo-small.png" alt="Python: Mutable Defaults and Decorators logo" class="visible-xs visible-sm">
                    <span class="sr-only">Python: Mutable Defaults and Decorators - go to homepage</span>
                </a>
                <div class="navbar-buttons">
                    <button type="button" class="navbar-toggle btn-template-main" data-toggle="collapse" data-target="#navigation">
                      <span class="sr-only">Toggle Navigation</span>
                        <i class="fa fa-align-justify"></i>
                    </button>
                </div>
            </div>
            

            <div class="navbar-collapse collapse" id="navigation">
                <ul class="nav navbar-nav navbar-right">
                  
                </ul>
            </div>
            

            <div class="collapse clearfix" id="search">

                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search">
                        <span class="input-group-btn">

                    <button type="submit" class="btn btn-template-main"><i class="fa fa-search"></i></button>

                </span>
                    </div>
                </form>

            </div>
            

        </div>
    </div>
    

</div>




        </header>

        <div id="heading-breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>Python: Mutable Defaults and Decorators</h1>
            </div>
        </div>
    </div>
</div>


        <div id="content">
            <div class="container">
                <div class="row">
                    
                    <div class="col-md-9" id="blog-post">
                        
                        <p class="text-muted mb-small text-right text-uppercase">
                            May 20, 2017<br/>
                            <i class="fa fa-clock-o"></i> 9 min. read</p>

                            <div id="post-content">
                                <p class="series_top_page">This post is part of the <a href="http://www.joesacher.com//series/python-tips">Python Tips</a> series.</p>
                                

<p>If you came directly to this article, you might want to read my previous on in this series with the link at the bottom.  We discussed the dangers of using mutable values for defaults in a function parameter.  In this article I&rsquo;ll discuss two things: using mutable defaults for good and decorators.  In the end, combining these together.</p>

<h3 id="using-the-default-mutable-for-good">Using the default mutable for good</h3>

<p>In developing a Python workflow for a custom system, I&rsquo;m interfacing with custom hardware to measure current and temperature.  The hardware call is much slower than the normal software.  These values will only change slowly compared to software (especially temperature).</p>

<p>I am writing a workflow that starts cycling slowly and eventually speeds up to faster than 1 second.  I&rsquo;m going through 144 members of the workflow and could call these functions in each one.  This is really a waste in processing time.   What if I had a system to cache values and only really call hardware after a certain amount of time.  This would be useful in not just hardware interfacing, but also in getting other expensive resources (like network queries) for something that doesn&rsquo;t change rapidly.</p>

<p>I could make some type of complex systems that manages calls to these hardware functions only when needed.  Surely there is an easier way.  (Programmers continually ask that.  Usually it is a good thing.)</p>

<p>What if the function itself could hold the call and only perform the expensive operations after a certain time?  That would be pretty cool.  Lets do that.</p>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">time</span>


<span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">get_time</span>(immediate<span style="color:#555">=</span>False, _cached<span style="color:#555">=</span>{<span style="color:#c30"></span><span style="color:#c30">&#39;last_call&#39;</span>: <span style="color:#f60">0</span>, <span style="color:#c30"></span><span style="color:#c30">&#39;value&#39;</span>: None}):
    <span style="color:#c30"></span><span style="color:#c30">&#34;&#34;&#34;
</span><span style="color:#c30">    Only calls expensive code if not called in a while.  Unless told to be immediate.
</span><span style="color:#c30">
</span><span style="color:#c30">    :param immediate: If True, ignore timing and make call immedately
</span><span style="color:#c30">
</span><span style="color:#c30">    Note: _cache is not mentioned, as we don&#39;t want the uset to pass in anything for _cache and mess up things.
</span><span style="color:#c30">    &#34;&#34;&#34;</span>
    CALL_TIME <span style="color:#555">=</span> <span style="color:#f60">1</span>   <span style="color:#09f;font-style:italic"># Make call if 1 second has passed</span>
    cur_time <span style="color:#555">=</span> time<span style="color:#555">.</span>time()
    <span style="color:#069;font-weight:bold">if</span> immediate <span style="color:#000;font-weight:bold">or</span> (cur_time <span style="color:#555">-</span> _cached[<span style="color:#c30"></span><span style="color:#c30">&#39;last_call&#39;</span>]) <span style="color:#555">&gt;</span> CALL_TIME:
        _cached[<span style="color:#c30"></span><span style="color:#c30">&#39;last_call&#39;</span>] <span style="color:#555">=</span> cur_time
        <span style="color:#09f;font-style:italic"># simulate expensive call</span>
        time<span style="color:#555">.</span>sleep(<span style="color:#f60">0.1</span>)
        _cached[<span style="color:#c30"></span><span style="color:#c30">&#39;value&#39;</span>] <span style="color:#555">=</span> time<span style="color:#555">.</span>time()
    <span style="color:#069;font-weight:bold">return</span> _cached[<span style="color:#c30"></span><span style="color:#c30">&#39;value&#39;</span>]</code></pre></div>

<p>In the function definition, we have an <code>immediate</code> parameter that is used to bypass the time cache.  This will call the expensive code now.  The <code>_cached</code> parameter defines a dictionary that stores data with te function between calls.  We have &lsquo;last_call&rsquo; that will store the time we last called the expensive code.  I stare with 0, so any call will trigger a trip through expensive code.  &lsquo;value&rsquo; will hold the result of the expensive call.</p>

<p><code>CALL_TIME</code> is a constant that sets the time we wait until next expensive call.  Here we are doing the expensive call if 1 second has passed.  I kept this short, so the tests run faster.</p>

<p>The <code>if</code> checks if we are calling in immediate mode or enough time has passed.  Inside we update our cached call time and get the value.  I&rsquo;m using <code>time.sleep</code> for 1/10th of a second to simulate slow call.  Then storing time.  This is easy to see the value has changed.</p>

<p>Lets defined a test that checks for a cached value for a second call, tests immediate call and waits past the cached time and see if the value changes.</p>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">test_cached_with_immediate</span>():
    time_a <span style="color:#555">=</span> get_time()  <span style="color:#09f;font-style:italic"># Should be current</span>
    time_b <span style="color:#555">=</span> get_time()  <span style="color:#09f;font-style:italic"># Should be cached time_a</span>
    <span style="color:#069;font-weight:bold">assert</span> time_a <span style="color:#555">==</span> time_b

    <span style="color:#09f;font-style:italic"># Sleep past cache and see value change</span>
    time<span style="color:#555">.</span>sleep(<span style="color:#f60">1</span>)
    time_c <span style="color:#555">=</span> get_time()
    <span style="color:#069;font-weight:bold">assert</span> time_c <span style="color:#555">&gt;</span> time_a

    <span style="color:#09f;font-style:italic"># Ignore cache and get current value</span>
    time_d <span style="color:#555">=</span> get_time(immediate<span style="color:#555">=</span>True)
    <span style="color:#069;font-weight:bold">assert</span> time_d <span style="color:#555">&gt;</span> time_c</code></pre></div>

<p>This test passes and it one of the slowest tests I&rsquo;ve written in a while.  1.33 seconds runtime.  Aren&rsquo;t we glad I didn&rsquo;t make it 30 second cache.  Testing would be a full commercial break.</p>

<p>This works how we want, but we need to add this caching to multiple hardware call.  So we just copy all the parts of this to each function and move along, right?</p>

<p>Woah, there.  Any time you think about copy and pasting around code, you are doing things wrong.  Python has a methodology to easily modify function called decoration.  (Its not just for holidays anymore!)</p>

<h3 id="decorators">Decorators</h3>

<p>I&rsquo;m going to start simple and work up, because a decorator to add the above functionality is not simple.  Functions in Python are first-class objects.  You can use them as arguments and pass then around.  You can also return them.  So it is possible to make a function that creates and returns a function.  Lets slowly work our way up in complexity.</p>

<p>This is a simple function and call.  Nothing should be new here.</p>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">first</span>(value):
    <span style="color:#069;font-weight:bold">return</span> <span style="color:#c30"></span><span style="color:#c30">&#39;first({})&#39;</span><span style="color:#555">.</span>format(value)

<span style="color:#069;font-weight:bold">print</span>(first(<span style="color:#f60">1</span>))</code></pre></div>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">first(1)</code></pre></div>

<p>This passes in a function and executes it inside of <code>outer</code>.</p>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">outer</span>(func, value):
    <span style="color:#069;font-weight:bold">return</span> func(value)

<span style="color:#069;font-weight:bold">print</span>(outer(first, <span style="color:#f60">2</span>))</code></pre></div>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">first(2)</code></pre></div>

<p>Here we show that you can define functions inside of <code>hold_function</code>.  These can only be executed inside the function.  But notice how they have access to variable defined outside their function definitions for <code>value</code>.</p>

<p><div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">hold_function</span>(value):

    <span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">inner_1</span>():
        <span style="color:#069;font-weight:bold">return</span> <span style="color:#c30"></span><span style="color:#c30">&#39;inner_1({})&#39;</span><span style="color:#555">.</span>format(value)

    <span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">inner_2</span>():
        <span style="color:#069;font-weight:bold">return</span> <span style="color:#c30"></span><span style="color:#c30">&#39;inner_2({})&#39;</span><span style="color:#555">.</span>format(value)

    <span style="color:#069;font-weight:bold">print</span>(inner_1())
    <span style="color:#069;font-weight:bold">print</span>(inner_2())

hold_function(<span style="color:#f60">3</span>)</code></pre></div>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">inner_1(3)
inner_2(3)</code></pre></div></p>

<p>Here <code>return_function</code> creates a function and returns it.  We assign this to <code>my_func</code> and it becomes a callable function.</p>

<p><div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">return_function</span>():
    <span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">internal_function</span>():
        <span style="color:#069;font-weight:bold">return</span> <span style="color:#c30"></span><span style="color:#c30">&#39;internal_function&#39;</span>
    <span style="color:#069;font-weight:bold">return</span> internal_function

my_func <span style="color:#555">=</span> return_function()
<span style="color:#069;font-weight:bold">print</span>(my_func())</code></pre></div>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">internal_function</code></pre></div></p>

<p>This is the simplest version of a decorator.  Calling <code>my_decorator</code> allows you to pass in a function and wraps code around it.  We call <code>my_function</code> first and just get the single output.  Then we reassign <code>my_function</code> to the internal <code>wrapper</code> function returned from <code>my_decorator</code>.  Executing this shows the wrapping with the original call in the middle.</p>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">my_decorator</span>(func):
    <span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">wrapper</span>(<span style="color:#555">*</span>args):
        <span style="color:#069;font-weight:bold">print</span>(<span style="color:#c30"></span><span style="color:#c30">&#34;Something is done before function call.&#34;</span>)
        func()
        <span style="color:#069;font-weight:bold">print</span>(<span style="color:#c30"></span><span style="color:#c30">&#34;Something is done after function call&#34;</span>)
    <span style="color:#069;font-weight:bold">return</span> wrapper

<span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">my_function</span>():
    <span style="color:#069;font-weight:bold">print</span>(<span style="color:#c30"></span><span style="color:#c30">&#34;Wheee!&#34;</span>)

my_function()
my_function <span style="color:#555">=</span> my_decorator(my_function)
my_function()</code></pre></div>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Wheee!
Something is done before function call.
Wheee!
Something is done after function call</code></pre></div>

<p>This uses the same <code>my_decorator</code> as the previous example, but is using syntactic sugar in Python for using decorators.  Using <code>@my_decorator</code> above a function definition is equivalent to <code>add_sugar = my_decorator(add_sugar)</code>.</p>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#99f">@my_decorator</span>
<span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">add_sugar</span>():
    <span style="color:#069;font-weight:bold">print</span>(<span style="color:#c30"></span><span style="color:#c30">&#34;Syntactic Sugar&#34;</span>)

add_sugar()</code></pre></div>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Something is done before function call.
Syntactic Sugar
Something is done after function call</code></pre></div>

<h3 id="common-decorators">Common decorators</h3>

<p>The first decorators you run into with Python is generally in classes and object programming.  Some examples are <code>@classmethod</code> indicating the method is at class level, <code>@staticmethod</code> indicating a method doesn&rsquo;t require object state to run, and <code>@property</code> making the method act like a value of the class.</p>

<h3 id="a-complex-caching-decorator">A complex caching decorator</h3>

<p>Now that we know what decorators are and how to make them, I&rsquo;m going to throw a fairly complex one at you and try to explain it.  I&rsquo;ll include the full version of my <code>decorators.py</code> file in two parts and try to talk you throught it.</p>

<p>I&rsquo;m importing <code>time</code> and <code>wraps</code> for the next block of code.  This <code>simple_decorator</code> decorator is used to copy the properties of the original function onto the one returned.  This makes it behave a little better in various ways when in use.  It isn&rsquo;t specifically needed, but makes things nicer.</p>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">time</span>
<span style="color:#069;font-weight:bold">from</span> <span style="color:#0cf;font-weight:bold">functools</span> <span style="color:#069;font-weight:bold">import</span> wraps


<span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">simple_decorator</span>(decorator):
    <span style="color:#c30"></span><span style="color:#c30">&#34;&#34;&#34;
</span><span style="color:#c30">    This decorator can be used to turn simple functions
</span><span style="color:#c30">    into well-behaved decorators, so long as the decorators
</span><span style="color:#c30">    are fairly simple. If a decorator expects a function and
</span><span style="color:#c30">    returns a function (no descriptors), and if it doesn&#39;t
</span><span style="color:#c30">    modify function attributes or docstring, then it is
</span><span style="color:#c30">    eligible to use this. Simply apply @simple_decorator to
</span><span style="color:#c30">    your decorator and it will automatically preserve the
</span><span style="color:#c30">    docstring and function attributes of functions to which
</span><span style="color:#c30">    it is applied.
</span><span style="color:#c30">    &#34;&#34;&#34;</span>
    <span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">new_decorator</span>(f):
        g <span style="color:#555">=</span> decorator(f)
        g<span style="color:#555">.</span>__name__ <span style="color:#555">=</span> f<span style="color:#555">.</span>__name__
        g<span style="color:#555">.</span>__doc__ <span style="color:#555">=</span> f<span style="color:#555">.</span>__doc__
        g<span style="color:#555">.</span>__dict__<span style="color:#555">.</span>update(f<span style="color:#555">.</span>__dict__)
        <span style="color:#069;font-weight:bold">return</span> g
    <span style="color:#09f;font-style:italic"># Now a few lines needed to make simple_decorator itself</span>
    <span style="color:#09f;font-style:italic"># be a well-behaved decorator.</span>
    new_decorator<span style="color:#555">.</span>__name__ <span style="color:#555">=</span> decorator<span style="color:#555">.</span>__name__
    new_decorator<span style="color:#555">.</span>__doc__ <span style="color:#555">=</span> decorator<span style="color:#555">.</span>__doc__
    new_decorator<span style="color:#555">.</span>__dict__<span style="color:#555">.</span>update(decorator<span style="color:#555">.</span>__dict__)
    <span style="color:#069;font-weight:bold">return</span> new_decorator</code></pre></div>

<p>Here is our <code>cached_with_immediate</code> decorator definition.  Since the timing of the cache will vary between uses, this is a passed in argument.  You can see an example of use at the bottom of the doc string.</p>

<p>The <code>_cached_with_immediate(main_func)</code> is the function we are returning with the decorator.  You can see this on the last line.</p>

<p>The <code>_decorator</code> function has <code>*args</code> to catch positional and <code>**kwargs</code> to catch named arguments to the original function.  We are adding our <code>_cached</code> argument that we don&rsquo;t expect anyone to call, and the <code>immediate</code> named parameter to allow cache-less call.</p>

<p>The code inside that function looks very similar to what we had up top.  Because we do the same thing wrapped around the call to <code>main_func(*args, **kwargs)</code>.</p>

<p>The <code>functool.wraps</code> call is used to get the name of the function proper, instead of using the inside function name.</p>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">cached_with_immediate</span>(call_time):
    <span style="color:#c30"></span><span style="color:#c30">&#34;&#34;&#34;
</span><span style="color:#c30">    Decorator that only calls expensive operations if past last call time.
</span><span style="color:#c30">
</span><span style="color:#c30">    Can specify immediate=True to make a call ignoring cached condition.
</span><span style="color:#c30">
</span><span style="color:#c30">    This is useful for using value of long running hardware processes when immediate value is not normally
</span><span style="color:#c30">    needed.  Such as a temperature conversion that can only vary much slower than code may call it.  So a
</span><span style="color:#c30">    few millisecond hardware process returns much faster if called often, as the hardware query and conversion
</span><span style="color:#c30">    is skipped.
</span><span style="color:#c30">
</span><span style="color:#c30">    Using property of default _cached dictionary staying with the function definition.
</span><span style="color:#c30">
</span><span style="color:#c30">    Example:
</span><span style="color:#c30">    @decorators.cached_with_immediate(call_time=30)
</span><span style="color:#c30">    def long_time_to_run_normally():
</span><span style="color:#c30">        return something_that_took_a_long_time_to_get
</span><span style="color:#c30">
</span><span style="color:#c30">    call function with immediate=True to ignore caching
</span><span style="color:#c30">    &#34;&#34;&#34;</span>
    <span style="color:#99f">@simple_decorator</span>
    <span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">_cached_with_immediate</span>(main_func):
        <span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">_decorator</span>(<span style="color:#555">*</span>args, _cached<span style="color:#555">=</span>{<span style="color:#c30"></span><span style="color:#c30">&#39;last_call&#39;</span>: <span style="color:#f60">0</span>, <span style="color:#c30"></span><span style="color:#c30">&#39;value&#39;</span>: None}, immediate<span style="color:#555">=</span>False, <span style="color:#555">**</span>kwargs):
            cur_time <span style="color:#555">=</span> time<span style="color:#555">.</span>time()
            <span style="color:#069;font-weight:bold">if</span> immediate <span style="color:#000;font-weight:bold">or</span> (cur_time <span style="color:#555">-</span> _cached[<span style="color:#c30"></span><span style="color:#c30">&#39;last_call&#39;</span>]) <span style="color:#555">&gt;</span> call_time:
                _cached[<span style="color:#c30"></span><span style="color:#c30">&#39;last_call&#39;</span>] <span style="color:#555">=</span> cur_time
                _cached[<span style="color:#c30"></span><span style="color:#c30">&#39;value&#39;</span>] <span style="color:#555">=</span> main_func(<span style="color:#555">*</span>args, <span style="color:#555">**</span>kwargs)
            <span style="color:#069;font-weight:bold">return</span> _cached[<span style="color:#c30"></span><span style="color:#c30">&#39;value&#39;</span>]
        <span style="color:#069;font-weight:bold">return</span> wraps(main_func)(_decorator)
    <span style="color:#069;font-weight:bold">return</span> _cached_with_immediate</code></pre></div>

<p>The reason this seems to have one more level of functions than previous decorators, is that the invocation of the decorator is actually a function call.  (The use is <code>@function()</code> instead of <code>@function</code>.  So the decorating creates a decorator using arguments given).</p>

<p>In operation, <code>cached_with_immediate</code> is called in defining the decorator with <code>@cached_with_immediate(call_time=30)</code>.  This returns the <code>_cached_with_immediate</code> function that is executed when the function is decorated.  The act of decorating returns the <code>_decorator</code> function, which replaces the original <code>main_func</code>.</p>

<p>Makes sense?  Hopefully.</p>

<h3 id="testing-the-decorator">Testing the decorator</h3>

<p>Below is the code I&rsquo;m using to test my decorator.  Notice how this <code>get_time</code> function has the same operation as the function we defined at the top of this post, just using our decorator.</p>

<p>I actually created it from this, by replacing the decorator functionality with native code.  This is why the tests are exactly the same.</p>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#99f">@cached_with_immediate</span>(call_time<span style="color:#555">=</span><span style="color:#f60">1</span>)  <span style="color:#09f;font-style:italic"># Will cache for 2 seconds</span>
<span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">get_time</span>():
    time<span style="color:#555">.</span>sleep(<span style="color:#f60">0.01</span>)  <span style="color:#09f;font-style:italic"># Assure time changes between calls</span>
    <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">float</span>(time<span style="color:#555">.</span>time())


<span style="color:#99f">@pytest.mark.slow</span>
<span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">test_cached_with_immediate</span>():
    time_a <span style="color:#555">=</span> get_time()  <span style="color:#09f;font-style:italic"># Should be current</span>
    time_b <span style="color:#555">=</span> get_time()  <span style="color:#09f;font-style:italic"># Should be cached time_a</span>
    <span style="color:#069;font-weight:bold">assert</span> time_a <span style="color:#555">==</span> time_b

    <span style="color:#09f;font-style:italic"># Sleep past cache and see value change</span>
    time<span style="color:#555">.</span>sleep(<span style="color:#f60">1</span>)
    time_c <span style="color:#555">=</span> get_time()
    <span style="color:#069;font-weight:bold">assert</span> time_c <span style="color:#555">&gt;</span> time_a

    <span style="color:#09f;font-style:italic"># Ignore cache and get current value</span>
    time_d <span style="color:#555">=</span> get_time(immediate<span style="color:#555">=</span>True)
    <span style="color:#069;font-weight:bold">assert</span> time_d <span style="color:#555">&gt;</span> time_c</code></pre></div>

<p>If you want to look at the code, this is part of my <a href="https://github.com/sacherjj/rpi-hardware/">rpi-hardware</a> project on GitHub.  Testing is in <a href="https://github.com/sacherjj/rpi-hardware/blob/master/tests/test_util.py">tests/test_util.py</a> and the decorator code is in <a href="https://github.com/sacherjj/rpi-hardware/blob/master/src/rpi_hardware/util/decorators.py">src/rpi_hardware/util/decorators.py</a>.</p>

<p>That is it for this one, hopefully it was helpful.</p>

                                <hr/>
        <p>Part 4 of 4
            in the <b>Python Tips</b> series.</p>
        <p><a href="http://www.joesacher.com/blog/2017/04/08/python-starting-tips/"><i class="fa fa-angle-left"></i>Series Start<i class="fa fa-angle-right"></i></a>
                     |
            <a href="http://www.joesacher.com/blog/2017/04/22/functions-and-mutable-defaults/"><i class="fa fa-angle-double-left"></i>Python: Functions and Mutable Defaults</a>
                             </div>
                        
                        
                        <div id="comments"><div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "joesachercom" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div>
                        

                    </div>
                    
                    

                    
                    <div class="col-md-3">
                        
<div class="panel panel-default sidebar-menu">

    <div class="panel-heading">
      <h3 class="panel-title">Categories</h3>
    </div>

    <div class="panel-body">
        <ul class="nav nav-pills nav-stacked">
            <li><a href="http://www.joesacher.com/categories/cooking" class="text-uppercase">cooking (2)</a>
            </li><li><a href="http://www.joesacher.com/categories/how-to" class="text-uppercase">how-to (5)</a>
            </li><li><a href="http://www.joesacher.com/categories/personal" class="text-uppercase">personal (9)</a>
            </li><li><a href="http://www.joesacher.com/categories/reviews" class="text-uppercase">reviews (14)</a>
            </li><li><a href="http://www.joesacher.com/categories/tech" class="text-uppercase">tech (31)</a>
            </li><li><a href="http://www.joesacher.com/categories/trans-am" class="text-uppercase">trans-am (48)</a>
            </li>
        </ul>
    </div>
</div>

<div class="panel panel-default sidebar-menu">

    <div class="panel-heading">
      <h3 class="panel-title">Blog Series</h3>
    </div>

    <div class="panel-body">
        <ul class="nav nav-pills nav-stacked">
            <li><a href="http://www.joesacher.com/series/hugo" class="text-uppercase">hugo (4)</a>
            </li><li><a href="http://www.joesacher.com/series/python-tips" class="text-uppercase">python-tips (4)</a>
            </li><li><a href="http://www.joesacher.com/series/python-to-rust" class="text-uppercase">python-to-rust (4)</a>
            </li><li><a href="http://www.joesacher.com/series/trans-am" class="text-uppercase">trans-am (48)</a>
            </li>
        </ul>
    </div>
</div>
<div class="panel sidebar-menu">
    <div class="panel-heading">
      <h3 class="panel-title">Tags</h3>
    </div>

    <div class="panel-body">
        <ul class="tag-cloud">
            <li><a href="http://www.joesacher.com/tags/android"><i class="fa fa-tags"></i> android</a>
            </li><li><a href="http://www.joesacher.com/tags/avr"><i class="fa fa-tags"></i> avr</a>
            </li><li><a href="http://www.joesacher.com/tags/bicycle"><i class="fa fa-tags"></i> bicycle</a>
            </li><li><a href="http://www.joesacher.com/tags/bicycle-touring"><i class="fa fa-tags"></i> bicycle-touring</a>
            </li><li><a href="http://www.joesacher.com/tags/book-review"><i class="fa fa-tags"></i> book-review</a>
            </li><li><a href="http://www.joesacher.com/tags/calendars"><i class="fa fa-tags"></i> calendars</a>
            </li><li><a href="http://www.joesacher.com/tags/comprehensions"><i class="fa fa-tags"></i> comprehensions</a>
            </li><li><a href="http://www.joesacher.com/tags/cooking"><i class="fa fa-tags"></i> cooking</a>
            </li><li><a href="http://www.joesacher.com/tags/cycling"><i class="fa fa-tags"></i> cycling</a>
            </li><li><a href="http://www.joesacher.com/tags/decorators"><i class="fa fa-tags"></i> decorators</a>
            </li><li><a href="http://www.joesacher.com/tags/dessert"><i class="fa fa-tags"></i> dessert</a>
            </li><li><a href="http://www.joesacher.com/tags/dry-bag"><i class="fa fa-tags"></i> dry-bag</a>
            </li><li><a href="http://www.joesacher.com/tags/ebooks"><i class="fa fa-tags"></i> ebooks</a>
            </li><li><a href="http://www.joesacher.com/tags/electronics"><i class="fa fa-tags"></i> electronics</a>
            </li><li><a href="http://www.joesacher.com/tags/enumerate"><i class="fa fa-tags"></i> enumerate</a>
            </li><li><a href="http://www.joesacher.com/tags/fiction"><i class="fa fa-tags"></i> fiction</a>
            </li><li><a href="http://www.joesacher.com/tags/film-making"><i class="fa fa-tags"></i> film-making</a>
            </li><li><a href="http://www.joesacher.com/tags/functions"><i class="fa fa-tags"></i> functions</a>
            </li><li><a href="http://www.joesacher.com/tags/google"><i class="fa fa-tags"></i> google</a>
            </li><li><a href="http://www.joesacher.com/tags/hacking"><i class="fa fa-tags"></i> hacking</a>
            </li><li><a href="http://www.joesacher.com/tags/ham-radio"><i class="fa fa-tags"></i> ham-radio</a>
            </li><li><a href="http://www.joesacher.com/tags/hugo"><i class="fa fa-tags"></i> hugo</a>
            </li><li><a href="http://www.joesacher.com/tags/humor"><i class="fa fa-tags"></i> humor</a>
            </li><li><a href="http://www.joesacher.com/tags/hvac"><i class="fa fa-tags"></i> hvac</a>
            </li><li><a href="http://www.joesacher.com/tags/inspiration"><i class="fa fa-tags"></i> inspiration</a>
            </li><li><a href="http://www.joesacher.com/tags/javascript"><i class="fa fa-tags"></i> javascript</a>
            </li><li><a href="http://www.joesacher.com/tags/lathes"><i class="fa fa-tags"></i> lathes</a>
            </li><li><a href="http://www.joesacher.com/tags/marriage"><i class="fa fa-tags"></i> marriage</a>
            </li><li><a href="http://www.joesacher.com/tags/navigation"><i class="fa fa-tags"></i> navigation</a>
            </li><li><a href="http://www.joesacher.com/tags/nonfiction"><i class="fa fa-tags"></i> nonfiction</a>
            </li><li><a href="http://www.joesacher.com/tags/pannier"><i class="fa fa-tags"></i> pannier</a>
            </li><li><a href="http://www.joesacher.com/tags/personal"><i class="fa fa-tags"></i> personal</a>
            </li><li><a href="http://www.joesacher.com/tags/photography"><i class="fa fa-tags"></i> photography</a>
            </li><li><a href="http://www.joesacher.com/tags/pizza"><i class="fa fa-tags"></i> pizza</a>
            </li><li><a href="http://www.joesacher.com/tags/podcasts"><i class="fa fa-tags"></i> podcasts</a>
            </li><li><a href="http://www.joesacher.com/tags/programming"><i class="fa fa-tags"></i> programming</a>
            </li><li><a href="http://www.joesacher.com/tags/projects"><i class="fa fa-tags"></i> projects</a>
            </li><li><a href="http://www.joesacher.com/tags/proposal"><i class="fa fa-tags"></i> proposal</a>
            </li><li><a href="http://www.joesacher.com/tags/python"><i class="fa fa-tags"></i> python</a>
            </li><li><a href="http://www.joesacher.com/tags/recipe"><i class="fa fa-tags"></i> recipe</a>
            </li><li><a href="http://www.joesacher.com/tags/recumbent"><i class="fa fa-tags"></i> recumbent</a>
            </li><li><a href="http://www.joesacher.com/tags/rust"><i class="fa fa-tags"></i> rust</a>
            </li><li><a href="http://www.joesacher.com/tags/safety"><i class="fa fa-tags"></i> safety</a>
            </li><li><a href="http://www.joesacher.com/tags/sewing"><i class="fa fa-tags"></i> sewing</a>
            </li><li><a href="http://www.joesacher.com/tags/strings"><i class="fa fa-tags"></i> strings</a>
            </li><li><a href="http://www.joesacher.com/tags/touchpad"><i class="fa fa-tags"></i> touchpad</a>
            </li><li><a href="http://www.joesacher.com/tags/touring"><i class="fa fa-tags"></i> touring</a>
            </li><li><a href="http://www.joesacher.com/tags/unicode"><i class="fa fa-tags"></i> unicode</a>
            </li><li><a href="http://www.joesacher.com/tags/video"><i class="fa fa-tags"></i> video</a>
            </li><li><a href="http://www.joesacher.com/tags/web"><i class="fa fa-tags"></i> web</a>
            </li><li><a href="http://www.joesacher.com/tags/webos"><i class="fa fa-tags"></i> webos</a>
            </li><li><a href="http://www.joesacher.com/tags/windows-phone"><i class="fa fa-tags"></i> windows-phone</a>
            </li><li><a href="http://www.joesacher.com/tags/woodworking"><i class="fa fa-tags"></i> woodworking</a>
            </li><li><a href="http://www.joesacher.com/tags/writing"><i class="fa fa-tags"></i> writing</a>
            </li>
        </ul>
    </div>
</div>

                    </div>
                    

                    

                </div>
                

            </div>
            
        </div>
        

        






<div id="copyright">
    <div class="container">
        <div class="col-md-12">
            
            <p class="pull-left">Copyright (c) 2002-2017 - Joe Sacher - All Rights Reserved.</p>
            
            <p class="pull-right">A modified version of 
              template by <a href="http://bootstrapious.com/free-templates">Bootstrapious</a>
              
              ported to Hugo by <a href="https://github.com/devcows/hugo-universal-theme">DevCows</a>
            </p>
        </div>
    </div>
</div>




    </div>
    

    



<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-3718160-3', 'auto');
ga('send', 'pageview');
</script>


<script src="//code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js"></script>

<script src="//maps.googleapis.com/maps/api/js?v=3.exp"></script>

<script src="http://www.joesacher.com/js/hpneo.gmaps.js"></script>
<script src="http://www.joesacher.com/js/gmaps.init.js"></script>
<script src="http://www.joesacher.com/js/front.js"></script>


<script src="http://www.joesacher.com/js/owl.carousel.min.js"></script>




  </body>
</html>
